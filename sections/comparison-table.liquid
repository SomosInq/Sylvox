{%- render 'section-spacing-collapsing' -%}

<div class="comparison-section section_width_{{ section.settings.section_width }}" style="
  {% if section.settings.background_image != blank %}
    background-image: url({{ section.settings.background_image | image_url }});
    background-size: cover;
    background-position: center;
  {% elsif section.settings.background_color != blank %}
    background-color: {{ section.settings.background_color }};
  {% endif %}
  padding: {{ section.settings.padding_top }}px {{ section.settings.padding_right }}px {{ section.settings.padding_bottom }}px {{ section.settings.padding_left }}px; margin: {{ section.settings.margin_top }}px {{ section.settings.margin_right }}px {{ section.settings.margin_bottom }}px {{ section.settings.margin_left }}px
">
  <div class="container text-{{ section.settings.text_alignment }} {{ section.settings.section_width }}">
    {% if section.settings.title != blank %}
      <h2 style="color: {{ section.settings.text_color }}; font-size: {{ section.settings.title_size }}px;">
        {{ section.settings.title }}
      </h2>
    {% endif %}
    {% if section.settings.description != blank %}
      <div style="color: {{ section.settings.text_color }}; font-size: {{ section.settings.text_size }}px;">
        {{ section.settings.description }}
      </div>
    {% endif %}
    {% if section.settings.button_text != blank and section.settings.button_url != blank %}
      <a href="{{ section.settings.button_url }}" class="btn" style="
        color: {{ section.settings.button_text_color }};
        background-color: {{ section.settings.button_background }};
        font-size: {{ section.settings.button_size }}px;
      ">
        {{ section.settings.button_text }}
      </a>
    {% endif %}

    <!-- Header Section -->
    <div class="comparison-header" style="display: grid; grid-template-columns: auto repeat({{ section.blocks.size }}, 1fr); gap: 1rem; margin-bottom: 2rem;">
      <div class="header-blank"></div>
      {% for block in section.blocks %}
        <div class="text-center header">
          <div class="top-title">{{ block.settings.header_title }}</div>
          <div class="icon-title-wrapper" style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
            {% if block.settings.icon %}
              <img src="{{ block.settings.icon | image_url }}" alt="Icon" style="height: 24px;">
            {% endif %}
            <strong>{{ block.settings.title }}</strong>
          </div>
          <div class="price" style="margin-top: 0.5rem;">
            {{ block.settings.price }}
          </div>
          {% if block.settings.button_label and block.settings.button_link %}
            <a href="{{ block.settings.button_link }}" class="btn mt-2" style="font-size: {{ section.settings.button_size }}px;">
              {{ block.settings.button_label }}
              {% if block.settings.button_image %}
                <img src="{{ block.settings.button_image | image_url }}" style="height: 1em; margin-left: 0.5em;" />
              {% endif %}
            </a>
          {% endif %}
        </div>
      {% endfor %}
    </div>

    <!-- Table Values Section -->
    <div class="comparison-values" style="display: grid; grid-template-columns: auto repeat({{ section.blocks.size }}, 1fr); gap: 1rem;">
      {% assign max_rows = 20 %}
      {% for i in (1..max_rows) %}
        {% assign heading_key = 'heading_' | append: i %}
        {% if section.settings[heading_key] != blank %}
          <div class="head"><strong>{{ section.settings[heading_key] }}</strong></div>
          {% for block in section.blocks %}
            {% assign value_key = 'value_' | append: i %}
            {% assign image_key = 'value_image_' | append: i %}
            <div class="text-center table-value">
              {% if block.settings[image_key] %}
                <img src="{{ block.settings[image_key] | image_url }}" alt="Value image" style="max-width: 80%; display: block; margin: 0 auto 0.5rem;" />
              {% endif %}
              {% if block.settings[value_key] != blank %}
                <div>{{ block.settings[value_key] }}</div>
              {% else %}
                <div>—</div>
              {% endif %}
            </div>
          {% endfor %}
        {% endif %}
      {% endfor %}
    </div>

    <!-- SEE ALL SPECS TOGGLE -->
    {% assign row_count = 0 %}
    {% for i in (1..max_rows) %}
      {% assign heading_key = 'heading_' | append: i %}
      {% if section.settings[heading_key] != blank %}
        {% assign row_count = row_count | plus: 1 %}
      {% endif %}
    {% endfor %}

    {% if row_count > 4 %}
      <div style="text-align: center; margin-top: 1rem;">
        <button onclick="toggleSpecs()" id="specToggleBtn" style="background: none; border: none; cursor: pointer;">
          <span>SEE ALL SPECS</span>
          <span id="toggleArrow">▼</span>
        </button>
      </div>

      <script>
        function toggleSpecs() {
          const btn = document.getElementById('specToggleBtn');
          const arrow = document.getElementById('toggleArrow');
          const rows = document.querySelectorAll('.comparison-values > .head, .comparison-values > .table-value');
          const isHidden = btn.classList.toggle('expanded');

          rows.forEach((row, index) => {
            if (index >= 4 * {{ section.blocks.size | plus: 1 }}) {
              row.style.display = isHidden ? 'grid' : 'none';
            }
          });

          arrow.textContent = isHidden ? '▲' : '▼';
        }

        document.addEventListener("DOMContentLoaded", () => {
          toggleSpecs();
        });
      </script>
    {% endif %}

    <!-- View All Comparisons Link -->
    <div style="text-align: center; margin-top: 2rem;">
      <a href="{{ section.settings.view_all_url }}" style="display: inline-flex; align-items: center; gap: 0.5em;">
        <span>{{ section.settings.view_all_text }}</span>
        {% if section.settings.view_all_icon %}
          <img src="{{ section.settings.view_all_icon | image_url }}" style="height: 1em;" alt="icon">
        {% endif %}
      </a>
    </div>

  </div>
</div>

{% schema %}
{
  "settings": [
    { "type": "text", "id": "view_all_text", "label": "View All Comparisons Text", "default": "View All Comparisons" },
    { "type": "url", "id": "view_all_url", "label": "View All Comparisons URL" },
    { "type": "image_picker", "id": "view_all_icon", "label": "Icon for View All Comparisons" }
  ],
  "blocks": [
    {
      "type": "values",
      "name": "Column",
      "settings": [
        { "type": "text", "id": "header_title", "label": "Top Title above Type" },
        { "type": "text", "id": "price", "label": "Price Text" }
      ]
    }
  ]
}
{% endschema %}
